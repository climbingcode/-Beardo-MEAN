var app=angular.module("app",["ngCookies","angularFileUpload","ngAnimate","ngRoute","ngDragDrop"]);app.directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])})})}}}]),app.directive("ngFadeIn",function(){"use strict";return function(a,b,c){a.$watch(c.ngShow,function(){angular.element(b).addClass("active")})}}),app.directive("ngImageDrag",["$document",function(){return function(a,b){var c=b[0];c.draggable=!0,c.addEventListener("dragstart",function(a){return a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("Text",this.id),this.classList.add("drag"),!1},!1),c.addEventListener("dragend",function(){return this.classList.remove("drag"),!1},!1)}}]),app.directive("ngDropBox",function(){return{scope:{drop:"&"},link:function(a,b){var c=b[0];c.addEventListener("dragover",function(a){return a.dataTransfer.dropeffect="move",a.preventDefault&&a.preventDefault(),this.classList.add("over"),!1},!1),c.addEventListener("dragenter",function(){return this.classList.add("over"),!1},!1),c.addEventListener("dragleave",function(){return this.classList.remove("over"),!1},!1),c.addEventListener("drop",function(a){a.stopPropagation&&a.stopPropagation(),this.classList.remove("over");var b=document.getElementById(a.dataTransfer.getData("Text"));return this.appendChild(b),!1},!1)}}}),app.factory("dataFactory",function(){var a={},b=!1;return a.hasBeard=function(){return b},a.getCorrectPath=function(a){return angular.forEach(a.data,function(a){a.picture&&(file_name=a.picture.split("/").splice(-1).pop(),a.picture="uploads/"+file_name)}),a},a.getIndexs=function(a){return angular.forEach(a,function(a,b){a.index=b}),a},a.averageVote=function(a,c){for(var d=0;d<a.length;d++){b=a[d],ratings=b.ratings,totalRatings=[],totalUpVotes=[];for(var e=0;e<ratings.length;e++)rating=ratings[e],totalRatings.push(totalRatings),"up"===rating.vote&&totalUpVotes.push(totalUpVotes);average=100/totalRatings.length*totalUpVotes.length,b.average=Math.round(average)}c(a)},a.getTopBeards=function(a){return a},a}),app.directive("ngFilters",[]).filter("index",function(){"use strict";return function(a,b){return b.indexOf(a)}}),app.directive("ngFilters",[]).filter("limit",function(){"use strict";return function(){}}),app.directive("ngFilters",[]).filter("findpath",function(){"use strict";return function(a){return a?"uploads/"+a.split("/").pop():void 0}}),app.directive("ngFilters",[]).filter("range",function(){"use strict";return function(a,b){b=parseInt(b),console.log(a,b)}}),app.directive("ngFilters",[]).filter("capitalize",function(){"use strict";return function(a){return a?a.charAt(0).toUpperCase()+a.slice(1):void 0}}),app.service("apiHandler",["$http","$upload",function(a,b){return{index:function(b,c){return a.get("api/"+b).success(function(a,b){console.log("success : ",b,a),c(a)}).error(function(a){console.log("failed : ",a)})},upload:function(a,c,d){b.upload({url:"api/beards",method:"POST",headers:{enctype:"multipart/form-data"},data:a,file:c}).progress(function(a){console.log("percent: "+parseInt(100*a.loaded/a.total))}).success(function(a){console.log("uploaded"),d(a)}).error(function(){console.log("error uploading"),d("error uploading")})},create:function(b,c,d){a.post("api/"+b,JSON.stringify(c)).success(function(a){console.log("submitted to api:",a),d(a)}).error(function(){console.log("api did not except"),d(null)})},show:function(b,c,d){a.post("api/"+b,JSON.stringify(c)).success(function(a,b){console.log("success : ",a,b),d(a)}).error(function(a){console.log("failed : ",a),d(null)})},update:function(b,c,d){a.post("api/"+b,JSON.stringify(c)).success(function(a,b){console.log("success : ",a,b),d(a)}).error(function(a){console.log("failed : ",a),d("not found")})},destroy:function(b,c,d){console.log(b),a.delete("api/"+b,c).success(function(a,b){console.log("success : ",a,b),d(a)}).error(function(a){console.log("failed : ",a),d("not found")})}}}]),app.controller("formCtrl",["$scope","apiHandler","dataFactory",function(a,b,c){a.beardtypes=[{image:"images/beard-1.png",name:"full beards"},{image:"images/beard-1.png",name:"partial beard"},{image:"images/beard-1.png",name:"goatie"}],a.form={},a.submitForm=function(){b.upload(a.form,a.photo,function(b){a.slidesLoaded,a.beards=b.beards,a.slidesLoaded=!0,c.averageVote([b.beard],function(b){a.beard=b[0]}),a.clickBeard()})},a.delete=function(c,d){b.destroy(c,d,function(b){(b.type="user deleted")&&(a.beard=!1)})}}]),app.controller("mainCtrl",["$scope","$cookies","apiHandler","dataFactory",function(a,b,c,d){a.beards=[],a.ratings=[],a.slidesLoaded=!1,a.inSession=!1,a.beard=!1,a.showBeards=!0,a.showForm=!1,a.clickBeard=function(){a.showBeards=!0,a.showForm=!1},a.clickForm=function(){a.showForm=!0,a.showBeards=!1},a.deleteBeard=function(){a.beard=!1,console.log("beard +",a.beard)},a.getBeards=function(){c.index("/beards",function(b){b.user&&(a.user=b.user,b.beard&&d.averageVote([b.beard],function(b){a.beard=b[0]}),a.inSession=!0),b.data.length>0&&d.averageVote(b.data,function(c){console.log("beards here",c),a.topBeards=d.getTopBeards(b.data),a.beards=c,a.slidesLoaded=!0})})},a.getBeards()}]),app.controller("sessionCtrl",["$scope","$http","$timeout","$routeParams","$cookies","apiHandler","dataFactory",function(a,b,c,d,e,f,g){a.logInError=!1,a.signIn=function(){f.show("session",a.signInForm,function(b){h(b),console.log(b),g.averageVote([b.beard],function(b){a.beard=b[0]})})},a.signUp=function(){f.create("user",a.signUpForm,function(a){h(a)})},a.logOut=function(){f.destroy("session",a.user,function(){console.log("user has been logged out!")}),a.inSession=!1,a.beard=!1,a.user=null};var h=function(b){b?(a.inSession=!0,a.user=b.data,b.beard&&(a.beard=b.beard),a.logInError=!1,a.clickBeard()):(console.log("error reached"),a.inSession=!1,a.logInError=!0,a.beard=!1,c(function(){a.logInError=!1},3e3)),console.log(a.hasBeard)}}]),app.controller("sliderCtrl",["$scope","apiHandler","dataFactory",function(a,b){a.currentIndex=0,a.sum=0,a.getSum=function(){a.sum+=1},a.setCurrentSlideIndex=function(b){a.currentIndex=b},a.isCurrentSlideIndex=function(b){return a.beards.length>0?a.currentIndex===b:void 0},a.prevSlide=function(){a.currentIndex=a.currentIndex<a.beards.length-1?++a.currentIndex:0},a.nextSlide=function(){a.currentIndex=a.currentIndex>0?--a.currentIndex:a.beards.length-1},a.downVote=function(){data={beard:a.beards[a.currentIndex]._id,vote:"down"},b.create("ratings",data,function(){ratings=a.beards[a.currentIndex].ratings}),a.prevSlide(),a.reloadSlides()},a.upVote=function(){data={beard:a.beards[a.currentIndex]._id,vote:"up"},b.create("ratings",data,function(){ratings=a.beards[a.currentIndex].ratings}),a.prevSlide(),a.reloadSlides()},a.submitComment=function(){a.comment.beard=a.beards[a.currentIndex]._id,console.log(a.comment),b.create("comments",a.comment,function(b){b=a.comment,a.comment={},a.comment_form.$setPristine(),b.created="Just Now",a.beards[a.currentIndex].comments.push(b)})}}]);